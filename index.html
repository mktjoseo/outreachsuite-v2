<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OutreachSuite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .console-font { font-family: 'Fira Code', monospace; }
        #log-container::-webkit-scrollbar, #ao-keyword-log-container::-webkit-scrollbar, #ao-log-container::-webkit-scrollbar { width: 8px; }
        #log-container::-webkit-scrollbar-track, #ao-keyword-log-container::-webkit-scrollbar-track, #ao-log-container::-webkit-scrollbar-track { background: #2d3748; }
        #log-container::-webkit-scrollbar-thumb, #ao-keyword-log-container::-webkit-scrollbar-thumb, #ao-log-container::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 20px; border: 3px solid #2d3748; }
        .disabled-btn, button:disabled, input:disabled { opacity: 0.6; cursor: not-allowed; }
        .sidebar-link { display: flex; align-items: center; gap: 0.75rem; color: #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem; transition: color 0.2s, background-color 0.2s; }
        .sidebar-link:hover { background-color: rgba(71, 85, 105, 0.5); }
        .sidebar-link.active { background-color: #475569; color: #ffffff; font-weight: 600; }
        .loader { border-top-color: #BF103C; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tag { display: inline-flex; align-items: center; background-color: #BF103C; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; margin: 0.25rem 0.4rem 0.25rem 0; }
        .tag-remove { margin-left: 0.5rem; width: 1rem; height: 1rem; border-radius: 50%; background-color: rgba(0,0,0,0.2); color: white; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; }
        .tag-remove:hover { background-color: rgba(0,0,0,0.4); }
        .category-tag { font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 0.375rem; font-weight: 600; text-transform: uppercase; }
        .dropdown-menu.hidden { display: none; }
        body.logged-out #app-container { display: none; }
        body.logged-in #auth-container { display: none; }
        body.logged-in #app-container { display: flex; }
        .project-card.active { box-shadow: 0 0 0 3px #BF103C; border-color: #BF103C; }
    </style>
</head>
<body class="bg-gray-100 logged-out">

    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-slate-50">
        <div class="p-8 bg-white rounded-xl shadow-lg max-w-md w-full">
            <div class="text-center">
                <h1 data-translate-key="login_title" class="text-4xl font-bold text-slate-800">Welcome to OutreachSuite</h1>
                <p data-translate-key="login_subtitle" class="text-slate-500 mt-2 mb-8">Please log in to access the tools.</p>
            </div>
            <div id="auth-error" class="hidden bg-red-100 text-red-700 text-sm p-3 rounded-lg mb-4"></div>
            <div id="auth-success" class="hidden bg-green-100 text-green-700 text-sm p-3 rounded-lg mb-4"></div>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#BF103C]">
                <input type="password" id="auth-password" placeholder="Password (min. 6 characters)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#BF103C]">
                <select id="auth-language" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                    <option value="en">English</option>
                    <option value="es">Español</option>
                </select>
                <div class="flex gap-4">
                    <button type="button" id="login-btn" data-translate-key="login_btn" class="w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-600 transition">Log In</button>
                    <button type="button" id="signup-btn" data-translate-key="signup_btn" class="w-full bg-[#BF103C] text-white font-bold py-3 px-4 rounded-lg hover:bg-opacity-90 transition">Sign Up</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="app-container" class="relative min-h-screen md:flex">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        <aside id="sidebar" class="w-64 bg-slate-800 text-white flex flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex items-center justify-between p-6 text-2xl font-bold border-b border-slate-700">
                <span data-translate-key="app_title">OutreachSuite</span>
                <button id="close-menu-button" class="md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <nav class="flex-grow p-4">
                <ul class="space-y-2">
                    <li><a href="#home" id="nav-home" class="sidebar-link" data-translate-key="nav_home"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>Dashboard</a></li>
                    <li><a href="#projects" id="nav-projects" class="sidebar-link" data-translate-key="nav_projects"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.158a1 1 0 01.768.363L8.106 4.894a1 1 0 00.768.363H16a1 1 0 011 1v2a1 1 0 00-1-1h-7.894a1 1 0 01-.768-.363L4.158 3.106A1 1 0 003.39 3H3a1 1 0 00-1 1v12a1 1 0 001 1h14a1 1 0 001-1V9a1 1 0 00-2 0v6H4V4a1 1 0 00-1-1H2z" /></svg>Projects</a></li>
                    <li><a href="#affinity-outreach" id="nav-affinity-outreach" class="sidebar-link" data-translate-key="nav_affinity"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 1.5a1.5 1.5 0 00-1.293.707l-7 12a1.5 1.5 0 001.293 2.293h14a1.5 1.5 0 001.293-2.293l-7-12A1.5 1.5 0 0010 1.5zM9 6a1 1 0 112 0 1 1 0 01-2 0zm1 9a1 1 0 110-2 1 1 0 010 2z" clip-rule="evenodd" /><circle cx="10" cy="3" r="1.5" /><circle cx="3" cy="15" r="1.5" /><circle cx="17" cy="15" r="1.5" /></svg>Affinity Outreach</a></li>
                    <li><a href="#hybrid-scraper" id="nav-hybrid-scraper" class="sidebar-link" data-translate-key="nav_hybrid"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>Hybrid Scraper</a></li>
                </ul>
            </nav>
            <div class="p-4 mt-auto border-t border-slate-700">
                <div class="flex items-center justify-center gap-2">
                    <button id="lang-es" class="px-3 py-1 text-sm rounded-md transition-colors">Español</button>
                    <button id="lang-en" class="px-3 py-1 text-sm rounded-md transition-colors">English</button>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col">
            <header class="bg-white shadow-sm border-b border-gray-200 p-4 flex justify-between items-center z-10">
                <button id="mobile-menu-button" class="text-slate-800 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                <div id="active-project-display" class="text-sm font-semibold text-slate-600 flex-grow"></div>
                <div id="user-profile-container" class="relative"></div>
            </header>
            <main class="flex-1 p-6 lg:p-10 overflow-y-auto">
                
                <div id="home-view" class="view">
                    <header class="mb-8"><h1 data-translate-key="home_title" class="text-4xl font-bold text-slate-800">Select a function</h1><p data-translate-key="home_subtitle" class="text-lg text-slate-500 mt-1">Choose one of the available tools to start.</p></header>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <a href="#affinity-outreach" class="view-switcher bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 group"><div class="flex-shrink-0 w-12 h-12 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 1.5a1.5 1.5 0 00-1.293.707l-7 12a1.5 1.5 0 001.293 2.293h14a1.5 1.5 0 001.293-2.293l-7-12A1.5 1.5 0 0010 1.5zM9 6a1 1 0 112 0 1 1 0 01-2 0zm1 9a1 1 0 110-2 1 1 0 010 2z" clip-rule="evenodd" /><circle cx="10" cy="3" r="1.5" /><circle cx="3" cy="15" r="1.5" /><circle cx="17" cy="15" r="1.5" /></svg></div><h3 data-translate-key="affinity_card_title" class="text-xl font-bold text-slate-800 mt-4">Affinity Outreach</h3><p data-translate-key="affinity_card_desc" class="text-slate-500 mt-1">Finds relevant blogs and media for your topic.</p></a>
                        <a href="#hybrid-scraper" class="view-switcher bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 group"><div class="flex-shrink-0 w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg></div><h3 data-translate-key="hybrid_card_title" class="text-xl font-bold text-slate-800 mt-4">Hybrid Scraper</h3><p data-translate-key="hybrid_card_desc" class="text-slate-500 mt-1">Scans any website to find contact emails.</p></a>
                    </div>
                </div>

                <div id="projects-view" class="view hidden">
                    <div class="container mx-auto max-w-5xl">
                        <header class="mb-8"><h1 data-translate-key="projects_title" class="text-4xl font-bold text-slate-800">My Projects</h1><p data-translate-key="projects_subtitle" class="text-lg text-slate-500 mt-1">Select a project to work on or create a new one.</p></header>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-1">
                                <div class="bg-white p-6 rounded-xl shadow-lg sticky top-6">
                                    <h3 data-translate-key="create_project_title" class="text-xl font-bold text-slate-800 mb-4">Create a New Project</h3>
                                    <form id="create-project-form" class="space-y-4">
                                        <div><label for="project-name" data-translate-key="project_name_label" class="block text-sm font-medium text-slate-600 mb-1">Project Name</label><input type="text" id="project-name" required class="w-full p-3 border border-gray-300 rounded-lg" data-translate-key="project_name_placeholder" placeholder="e.g., Launch Campaign for Client X"></div>
                                        <div><label for="project-url" data-translate-key="project_url_label" class="block text-sm font-medium text-slate-600 mb-1">Project URL</label><input type="url" id="project-url" required class="w-full p-3 border border-gray-300 rounded-lg" data-translate-key="project_url_placeholder" placeholder="e.g., https://client-x.com"></div>
                                        <div><label for="project-keywords" data-translate-key="project_keywords_label" class="block text-sm font-medium text-slate-600 mb-1">Keywords (optional)</label><input type="text" id="project-keywords" class="w-full p-3 border border-gray-300 rounded-lg" data-translate-key="project_keywords_placeholder" placeholder="Enter keywords separated by commas"></div>
                                        <button type="submit" id="create-project-btn" data-translate-key="create_project_btn" class="w-full bg-[#BF103C] text-white font-bold py-3 px-4 rounded-lg hover:bg-opacity-90 transition">Create Project</button>
                                    </form>
                                    <div id="project-form-error" class="hidden mt-3 bg-red-100 text-red-700 text-sm p-2 rounded-lg"></div>
                                </div>
                            </div>
                            <div class="lg:col-span-2"><div id="projects-list-container" class="space-y-4"></div></div>
                        </div>
                    </div>
                </div>

                <div id="hybrid-scraper-view" class="view hidden">
                    <div class="container mx-auto max-w-5xl">
                        <header class="relative text-left mb-8"><h1 data-translate-key="hybrid_title" class="text-4xl sm:text-5xl font-bold text-[#39414E]">Hybrid Scraper</h1><p data-translate-key="hybrid_subtitle" class="mt-2 text-lg text-gray-500">Uncover contact information from any website.</p></header>
                        <div class="bg-white p-4 rounded-xl shadow-lg"><div class="flex flex-col sm:flex-row gap-3"><input type="url" id="urlInput" data-translate-key="hybrid_placeholder" placeholder="Enter the website URL to investigate..." class="flex-grow p-4 border border-gray-200 rounded-lg text-lg"><button id="scrapeBtn" class="bg-[#BF103C] text-white font-semibold py-4 px-8 rounded-lg flex items-center justify-center text-lg"><span id="search-btn-text" data-translate-key="hybrid_search_btn">Search</span></button></div></div>
                        <div id="log-console" class="mt-8 bg-gray-800 rounded-xl shadow-lg hidden"><div class="bg-gray-700 rounded-t-lg px-4 py-2 flex items-center"><span class="h-3 w-3 bg-red-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-yellow-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-green-500 rounded-full"></span><span class="ml-4 text-gray-300 console-font text-sm">Process Console</span></div><div id="log-container" class="p-4 console-font text-sm h-96 overflow-y-auto"></div></div>
                        <div id="prompt-container" class="mt-6 hidden"><div class="bg-gray-800 p-6 rounded-lg shadow-md text-left"><p class="text-lg font-semibold text-[#0FCCC9] console-font" id="prompt-message"></p><div id="prompt-links" class="mt-4 mb-6 p-4 bg-black bg-opacity-20 rounded-md space-y-2 max-h-48 overflow-y-auto"></div><div class="flex justify-center gap-4"><button id="deep-scan-btn" class="w-full bg-[#0FCCC9] text-[#39414E] font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>Execute Deep Scan</button></div></div></div>
                        <div id="ai-prompt-container" class="mt-6 hidden"><div class="bg-gray-800 p-6 rounded-lg shadow-md text-left"><p class="text-lg font-semibold text-purple-400 console-font" id="ai-prompt-title"></p><p class="mt-2 text-gray-300 console-font" id="ai-prompt-subtitle"></p><div class="flex justify-center gap-4 mt-6"><button id="ask-ai-btn" class="w-full bg-[#BF103C] text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>Engage Gemini AI</button></div></div></div>
                        <div id="results" class="mt-10 hidden"><h2 class="text-2xl font-bold text-[#39414E] mb-4">Final Results</h2><div id="emails-container" class="mb-8 hidden"><h3 class="text-xl font-semibold text-gray-700 mb-3">Emails Found</h3><div id="emailList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div><div id="socials-container" class="hidden"><h3 class="text-xl font-semibold text-gray-700 mb-3">Social & Contact Links</h3><div id="socialList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div></div>
                        <div id="error-message" class="hidden mt-6 bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-r-lg" role="alert"><p class="font-bold">An error occurred!</p><p id="error-text"></p></div>
                    </div>
                </div>

                <div id="affinity-outreach-view" class="view hidden">
                    <div class="container mx-auto max-w-4xl">
                        <header class="text-center mb-8"><h1 data-translate-key="affinity_title" class="text-3xl md:text-4xl font-bold text-[#39414E] mb-2">Affinity Outreach Finder</h1><p data-translate-key="affinity_subtitle" class="text-gray-600">Discover relevant media outlets based on real SEO data.</p></header>
                        <main>
                            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                                <h3 data-translate-key="step1_title" class="text-xl font-bold text-slate-800 mb-4">1. Analyze Your Project for Keywords</h3>
                                <div><label for="ao-projectUrl" data-translate-key="project_url_label" class="block text-sm font-medium text-[#39414E] mb-2">Project URL</label><div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2"><input type="url" id="ao-projectUrl" class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3" data-translate-key="project_url_placeholder" placeholder="e.g., https://yourproject.com"><div class="flex-shrink-0 flex"><button type="button" id="ao-generateKeywordsButton" class="bg-[#0FCCC9] hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg text-sm flex items-center justify-center w-full"><span id="ao-generate-btn-text" data-translate-key="analyze_btn">Analyze & Generate</span><div id="ao-generate-loader" class="loader ease-linear rounded-full border-2 border-t-2 border-white h-4 w-4 ml-2 hidden"></div></button></div></div></div>
                                <div id="ao-keyword-log-console" class="hidden mt-4 bg-gray-800 rounded-xl shadow-lg"><div class="bg-gray-700 rounded-t-lg px-4 py-2 flex items-center"><span class="h-3 w-3 bg-red-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-yellow-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-green-500 rounded-full"></span><span class="ml-4 text-gray-300 console-font text-sm">Keyword Analysis Log</span></div><div id="ao-keyword-log-container" class="p-4 console-font text-sm text-left text-gray-300 h-40 overflow-y-auto"></div></div>
                                <div id="ao-keyword-errorMessage" class="hidden mt-4 bg-red-100 border-red-400 text-red-700 px-4 py-3 rounded-lg text-center" role="alert"><strong class="font-bold">Analysis Error!</strong><span class="block sm:inline" id="ao-keyword-errorText"></span></div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 data-translate-key="step2_title" class="text-xl font-bold text-slate-800 mb-4">2. Find Affinity Media</h3>
                                <form id="ao-searchForm">
                                    <div class="space-y-6">
                                        <div><label for="ao-keyword-input" data-translate-key="keywords_label" class="block text-sm font-medium text-[#39414E] mb-2">Keywords or Topics</label><div class="flex items-center space-x-2 w-full bg-gray-100 border border-gray-300 rounded-lg p-1"><div id="ao-tags-container" class="flex-grow flex flex-wrap items-center gap-2"><input type="text" id="ao-keyword-input" data-translate-key="add_keyword_placeholder" class="flex-grow bg-transparent border-none focus:ring-0 text-sm p-1" placeholder="Add keyword & press Enter..."></div><button type="button" id="ao-add-keyword-btn" data-translate-key="add_btn" class="flex-shrink-0 bg-[#BF103C] text-white rounded-md h-8 w-14 text-sm font-bold hover:bg-opacity-80">Add</button></div></div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start"><div><label for="ao-searchType" data-translate-key="search_type_label" class="block text-sm font-medium text-[#39414E] mb-2">Search Type</label><select id="ao-searchType" class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3"><option value="top_authority" selected>Top Authority (Top 1-10)</option><option value="established">Established Media (Top 11-30)</option><option value="rising_stars">Rising Stars (Top 31-50)</option></select></div><div id="ao-searchType-description" class="bg-slate-50 p-3 rounded-lg text-sm text-slate-600 mt-2 md:mt-0"></div></div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="ao-country" data-translate-key="country_label" class="block text-sm font-medium text-[#39414E] mb-2">Country</label><select id="ao-country" class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3"><option value="AR">Argentina</option><option value="AT">Austria</option><option value="BR">Brazil</option><option value="CL">Chile</option><option value="CO">Colombia</option><option value="FR">France</option><option value="DE">Germany</option><option value="IT">Italy</option><option value="MX">Mexico</option><option value="PL">Poland</option><option value="PT">Portugal</option><option value="ES">Spain</option><option value="CH">Switzerland</option><option value="GB">United Kingdom</option><option value="US" selected>USA</option></select></div><div><label for="ao-language" data-translate-key="language_label" class="block text-sm font-medium text-[#39414E] mb-2">Language</label><select id="ao-language" class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3"><option value="en" selected>English</option><option value="fr">French</option><option value="de">German</option><option value="it">Italian</option><option value="pl">Polish</option><option value="pt">Portuguese</option><option value="es">Spanish</option></select></div></div>
                                        <div class="flex justify-center pt-2"><button type="submit" id="ao-searchButton" data-translate-key="search_media_btn" class="w-full md:w-1/2 bg-[#BF103C] hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mr-2" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>Search Media</button></div>
                                    </div>
                                </form>
                            </div>
                            <div id="ao-log-console" class="hidden mt-6 bg-gray-800 rounded-xl shadow-lg"><div class="bg-gray-700 rounded-t-lg px-4 py-2 flex items-center"><span class="h-3 w-3 bg-red-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-yellow-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-green-500 rounded-full"></span><span class="ml-4 text-gray-300 console-font text-sm">Search Process Log</span></div><div id="ao-log-container" class="p-4 console-font text-sm text-left text-gray-300 h-48 overflow-y-auto"></div></div>
                            <div id="ao-loader" class="hidden text-center my-10"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto mb-4"></div><p class="text-lg text-gray-500">Analyzing the web... This may take a moment.</p></div>
                            <div id="ao-errorMessage" class="hidden bg-red-100 border-red-400 text-red-700 px-4 py-3 rounded-lg text-center mt-6" role="alert"><strong class="font-bold">Error!</strong><span class="block sm:inline" id="ao-errorText"></span></div>
                            <div id="ao-resultsArea" class="hidden mt-12"><section id="ao-directResultsSection"><div class="flex flex-col md:flex-row justify-between items-center mb-4"><h2 class="text-2xl font-bold text-[#39414E] mb-2 md:mb-0">Found Media</h2><div class="flex space-x-2"><button id="ao-sortButton" class="bg-[#0FCCC9] hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg text-sm">Sort by Relevance</button><button id="ao-exportButton" class="bg-[#BF103C] hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg text-sm">Export Selected</button></div></div><div id="ao-resultsSummary" class="mb-4 text-sm text-gray-600"></div><div id="ao-resultsList" class="space-y-4"></div></section></div>
                        </main>
                    </div>
                </div>

                <div id="settings-view" class="view hidden">
                    <div class="container mx-auto max-w-3xl">
                        <header class="mb-8"><h1 data-translate-key="settings_title" class="text-4xl font-bold text-slate-800">Settings</h1><p data-translate-key="settings_subtitle" class="text-lg text-slate-500 mt-1">Manage your preferences and API keys.</p></header>
                        <div id="settings-success" class="hidden bg-green-100 text-green-700 text-sm p-3 rounded-lg mb-6"></div>
                        <div class="space-y-8">
                             <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 data-translate-key="profile_settings_title" class="text-xl font-bold text-slate-800 mb-4">Profile Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="user-first-name" data-translate-key="first_name_label" class="block text-sm font-medium text-[#39414E] mb-2">First Name</label><input type="text" id="user-first-name" class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3"></div>
                                    <div><label for="user-last-name" data-translate-key="last_name_label" class="block text-sm font-medium text-[#39414E] mb-2">Last Name</label><input type="text" id="user-last-name" class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3"></div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 data-translate-key="api_keys_title" class="text-xl font-bold text-slate-800 mb-2">API Keys</h3>
                                <p data-translate-key="api_keys_subtitle" class="text-sm text-slate-500 mb-6">This feature will be enabled in a future update.</p>
                                <div class="space-y-4">
                                    <div><label for="gemini-key" class="block text-sm font-medium text-[#39414E] mb-2">Gemini API Key</label><input type="password" id="gemini-key" placeholder="Paste your Gemini API key" disabled class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3"></div>
                                    <div><label for="serper-key" class="block text-sm font-medium text-[#39414E] mb-2">Serper API Key</label><input type="password" id="serper-key" placeholder="Paste your Serper API key" disabled class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3"></div>
                                    <div><label for="scraper-key" class="block text-sm font-medium text-[#39414E] mb-2">ScraperAPI Key</label><input type="password" id="scraper-key" placeholder="Paste your ScraperAPI key" disabled class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3"></div>
                                </div>
                            </div>
                             <div class="flex justify-end"><button id="save-settings-btn" data-translate-key="save_settings_btn" class="bg-[#BF103C] text-white font-bold py-3 px-6 rounded-lg hover:bg-opacity-90 transition">Save Settings</button></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { createClient } = supabase;
            const SUPABASE_URL = 'https://xdrzsunisujjrghjntnn.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkcnpzdW5pc3VqanJnaGpudG5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNjYyODcsImV4cCI6MjA2ODg0MjI4N30.jAZA8q2niY7MTO7jolyKAPiFcRVmKu2-ObSrCoXfhGk';
            const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- GLOBAL STATE & DOM REFERENCES ---
            const body = document.body;
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const userProfileContainer = document.getElementById('user-profile-container');
            const activeProjectDisplay = document.getElementById('active-project-display');
            let currentTranslations = {};
            let isAppInitialized = false;
            let activeProject = null;
            let ao_keywords = [];
            let ao_currentResults = [];

            // --- TRANSLATION FUNCTION ---
            const translatePage = async (lang) => {
                const response = await fetch(`/lang/${lang}.json`);
                const translations = await response.json();
                currentTranslations = translations;
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key');
                    if (translations[key]) {
                        if (el.placeholder !== undefined) el.placeholder = translations[key];
                        else el.textContent = translations[key];
                    }
                });
                document.title = translations['app_title'] || 'OutreachSuite';
                const langBtn = document.getElementById(lang === 'en' ? 'lang-en' : 'lang-es');
                const otherBtn = document.getElementById(lang === 'en' ? 'lang-es' : 'lang-en');
                langBtn.classList.add('bg-white', 'text-slate-800');
                otherBtn.classList.remove('bg-white', 'text-slate-800');
            };

            // --- AUTH UI FUNCTIONS ---
            const showAuthMessage = (message, type = 'error') => {
                const div = document.getElementById(type === 'error' ? 'auth-error' : 'auth-success');
                document.getElementById('auth-error').classList.add('hidden');
                document.getElementById('auth-success').classList.add('hidden');
                div.textContent = message;
                div.classList.remove('hidden');
            };

            const updateUserAvatar = (user) => {
                let initials = (user.email.substring(0, 2) || '??').toUpperCase();
                if (user.user_metadata?.first_name && user.user_metadata?.last_name) {
                    initials = (user.user_metadata.first_name[0] + user.user_metadata.last_name[0]).toUpperCase();
                }
                userProfileContainer.innerHTML = `
                    <button id="user-avatar-btn" class="w-10 h-10 bg-slate-700 text-white font-bold rounded-full flex items-center justify-center">${initials}</button>
                    <div id="user-dropdown-menu" class="dropdown-menu hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-1 z-20">
                        <div class="px-4 py-2 border-b">
                            <p class="text-sm font-semibold text-gray-700 truncate">${user.user_metadata?.first_name || 'User'}</p>
                            <p class="text-xs text-gray-500 truncate">${user.email}</p>
                        </div>
                        <a href="#settings" class="sidebar-link-in-menu block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-translate-key="nav_settings">Settings</a>
                        <a href="#" id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-translate-key="logout_btn">Logout</a>
                    </div>
                `;
            };
            
            // =================================================================================
            // 🚀 APP INITIALIZATION
            // =================================================================================
            const initializeApp = async (user) => {
                if (isAppInitialized) return;
                isAppInitialized = true;
                
                // --- NAVIGATION & VIEW HANDLING ---
                const views = document.querySelectorAll('.view');
                const navLinks = document.querySelectorAll('.sidebar-link');
                const viewSwitchers = document.querySelectorAll('.view-switcher');
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const mobileMenuButton = document.getElementById('mobile-menu-button');
                const closeMenuButton = document.getElementById('close-menu-button');

                const toggleMenu = () => sidebar.classList.toggle('-translate-x-full');
                const showView = (viewId) => {
                    views.forEach(view => view.classList.add('hidden'));
                    const targetView = document.getElementById(viewId + '-view');
                    if(targetView) targetView.classList.remove('hidden'); else document.getElementById('home-view').classList.remove('hidden');
                    navLinks.forEach(link => link.classList.toggle('active', link.getAttribute('href') === '#' + viewId));
                    window.scrollTo(0, 0); 
                    if(viewId === 'projects') loadProjects();
                };
                window.showOutreachSuiteView = showView; // Make globally accessible
                
                const handleLinkClick = (e) => {
                    e.preventDefault();
                    const viewId = e.currentTarget.getAttribute('href').substring(1);
                    window.location.hash = viewId;
                    showView(viewId);
                    if (window.innerWidth < 768) toggleMenu();
                };

                mobileMenuButton.addEventListener('click', toggleMenu);
                closeMenuButton.addEventListener('click', toggleMenu);
                overlay.addEventListener('click', toggleMenu);
                navLinks.forEach(link => link.addEventListener('click', handleLinkClick));
                viewSwitchers.forEach(switcher => switcher.addEventListener('click', handleLinkClick));
                
                // --- LANGUAGE SWITCHER ---
                document.getElementById('lang-en').addEventListener('click', () => sb.auth.updateUser({ data: { language: 'en' } }).then(() => translatePage('en')));
                document.getElementById('lang-es').addEventListener('click', () => sb.auth.updateUser({ data: { language: 'es' } }).then(() => translatePage('es')));

                // --- INITIAL VIEW ---
                const initialView = window.location.hash ? window.location.hash.substring(1) : 'home';
                showView(initialView);
                
                // =================================================================================
                // ⚙️ SETTINGS LOGIC
                // =================================================================================
                const userFirstNameInput = document.getElementById('user-first-name');
                const userLastNameInput = document.getElementById('user-last-name');
                const saveSettingsBtn = document.getElementById('save-settings-btn');
                const settingsSuccessDiv = document.getElementById('settings-success');
                
                userFirstNameInput.value = user.user_metadata?.first_name || '';
                userLastNameInput.value = user.user_metadata?.last_name || '';
                
                saveSettingsBtn.addEventListener('click', async () => {
                    settingsSuccessDiv.classList.add('hidden');
                    const { data, error } = await sb.auth.updateUser({ data: { first_name: userFirstNameInput.value, last_name: userLastNameInput.value } });
                    if (error) {
                        alert('Error: ' + error.message);
                    } else {
                        updateUserAvatar(data.user);
                        settingsSuccessDiv.textContent = currentTranslations['settings_saved_success'];
                        settingsSuccessDiv.classList.remove('hidden');
                    }
                });

                // =================================================================================
                // 📝 PROJECTS LOGIC
                // =================================================================================
                const createProjectForm = document.getElementById('create-project-form');
                const projectsListContainer = document.getElementById('projects-list-container');
                
                const setActiveProject = (project, cardElement) => {
                    activeProject = project;
                    document.querySelectorAll('.project-card').forEach(card => card.classList.remove('active'));
                    if (cardElement) cardElement.classList.add('active');
                    activeProjectDisplay.innerHTML = `<span class="font-normal mr-2">Project:</span> <strong>${project.name}</strong>`;
                    // Pre-fill Affinity Outreach tool
                    document.getElementById('ao-projectUrl').value = project.url || '';
                    ao_keywords = [...(project.keywords || [])];
                    ao_renderTags();
                };

                const loadProjects = async () => {
                    const { data: projects, error } = await sb.from('projects').select('*').order('created_at', { ascending: false });
                    if (error) { alert('Error loading projects: ' + error.message); return; }

                    projectsListContainer.innerHTML = '';
                    if (projects.length === 0) {
                        projectsListContainer.innerHTML = `<div class="text-center py-10 px-6 bg-white rounded-xl shadow-sm"><p data-translate-key="no_projects" class="font-medium text-slate-500">${currentTranslations['no_projects']}</p></div>`;
                    } else {
                        projects.forEach(project => {
                            const card = document.createElement('div');
                            card.className = 'project-card bg-white p-5 rounded-xl shadow-md border-2 border-transparent transition-all cursor-pointer hover:border-slate-300';
                            card.innerHTML = `<h4 class="font-bold text-lg text-slate-800">${project.name}</h4><a href="${project.url}" target="_blank" rel="noopener noreferrer" class="text-sm text-sky-600 hover:underline break-all">${project.url}</a>`;
                            card.addEventListener('click', () => setActiveProject(project, card));
                            projectsListContainer.appendChild(card);
                        });
                        // Auto-select the first project if none is active
                        if (!activeProject && projects.length > 0) {
                           setActiveProject(projects[0], projectsListContainer.firstElementChild);
                        }
                    }
                };
                
                createProjectForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('project-name').value;
                    const url = document.getElementById('project-url').value;
                    const keywords = document.getElementById('project-keywords').value.split(',').map(k => k.trim()).filter(Boolean);
                    const { error } = await sb.from('projects').insert({ user_id: user.id, name, url, keywords });
                    if (error) { alert('Error: ' + error.message); } 
                    else { createProjectForm.reset(); loadProjects(); }
                });
                
                // =================================================================================
                // 🛠️ HYBRID SCRAPER LOGIC (from v1)
                // =================================================================================
                const hs_urlInput = document.getElementById('urlInput');
                const hs_scrapeBtn = document.getElementById('scrapeBtn');
                const hs_searchBtnText = document.getElementById('search-btn-text');
                const hs_logConsole = document.getElementById('log-console');
                const hs_logContainer = document.getElementById('log-container');
                const hs_promptContainer = document.getElementById('prompt-container');
                const hs_promptMessage = document.getElementById('prompt-message');
                const hs_promptLinks = document.getElementById('prompt-links');
                const hs_deepScanBtn = document.getElementById('deep-scan-btn');
                const hs_aiPromptContainer = document.getElementById('ai-prompt-container');
                const hs_aiPromptTitle = document.getElementById('ai-prompt-title');
                const hs_askAiBtn = document.getElementById('ask-ai-btn');
                const hs_resultsContainer = document.getElementById('results');
                const hs_emailsContainer = document.getElementById('emails-container');
                const hs_emailList = document.getElementById('emailList');
                const hs_socialsContainer = document.getElementById('socials-container');
                const hs_socialList = document.getElementById('socialList');
                const hs_errorContainer = document.getElementById('error-message');
                const hs_errorText = document.getElementById('error-text');
                let hs_foundEmails = new Map(), hs_foundLinks = new Map(), hs_internalLinks = new Set(), hs_targetDomain = '';

                const hs_log = (message, type = 'info') => {
                    const color = { info: 'text-gray-300', success: 'text-green-400', error: 'text-red-400', warn: 'text-yellow-400', step: 'text-cyan-400 font-bold' };
                    hs_logContainer.innerHTML += `<p class="${color[type]}"><span class="text-gray-500 mr-2">[${new Date().toLocaleTimeString()}]</span>${message}</p>`;
                    hs_logContainer.scrollTop = hs_logContainer.scrollHeight;
                };
                const hs_resetUI = () => {
                    hs_logConsole.classList.add('hidden'); hs_logContainer.innerHTML = '';
                    hs_promptContainer.classList.add('hidden'); hs_aiPromptContainer.classList.add('hidden');
                    hs_resultsContainer.classList.add('hidden'); hs_errorContainer.classList.add('hidden');
                    hs_emailsContainer.classList.add('hidden'); hs_socialsContainer.classList.add('hidden');
                    hs_emailList.innerHTML = ''; hs_socialList.innerHTML = '';
                    hs_foundEmails.clear(); hs_foundLinks.clear(); hs_internalLinks.clear();
                    hs_targetDomain = ''; hs_scrapeBtn.disabled = false;
                    hs_searchBtnText.textContent = currentTranslations['hybrid_search_btn'];
                };
                const hs_normalizeUrl = (url) => { let n = url.trim(); if (!/^(https?:\/\/)/i.test(n)) { n = 'https://' + n; } return n; };
                const hs_extractData = (html, sourceUrl) => {
                    const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
                    (html.match(emailRegex) || []).forEach(e => { const c = e.toLowerCase(); if (!/\.(png|jpg|jpeg|gif|svg|webp)$/i.test(c) && !hs_foundEmails.has(c)) { hs_foundEmails.set(c, sourceUrl); } });
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    doc.querySelectorAll('a[href]').forEach(link => {
                        const href = link.getAttribute('href'); if (!href) return;
                        if (href.startsWith('mailto:')) { const e = href.substring(7).split('?')[0].toLowerCase(); if (e && !hs_foundEmails.has(e)) hs_foundEmails.set(e, sourceUrl); return; }
                        try {
                            const fullUrl = new URL(href, sourceUrl);
                            const socialKeywords = ['linkedin.com/company', 'twitter.com', 'facebook.com', 'instagram.com'];
                            const contactKeywords = ['contact', 'about', 'team', 'impressum'];
                            if (socialKeywords.some(kw => fullUrl.href.includes(kw))) { if (!hs_foundLinks.has(fullUrl.href)) hs_foundLinks.set(fullUrl.href, sourceUrl); }
                            else { const lh = fullUrl.hostname.replace('www.', ''); if ((lh === hs_targetDomain || lh.endsWith(`.${hs_targetDomain}`)) && contactKeywords.some(kw => fullUrl.href.toLowerCase().includes(kw))) { hs_internalLinks.add(fullUrl.href); } }
                        } catch (e) {}
                    });
                };
                const hs_createResultCard = (text, sourceUrl, type) => {
                    const icons = { email: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>`, linkedin: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5V8h3zM6.5 6.73c-.966 0-1.75-.79-1.75-1.76s.784-1.76 1.75-1.76 1.75.79 1.75 1.76-.783 1.76-1.75 1.76zM19 19h-3v-5.6c0-1.33-.027-3.03-1.85-3.03-1.85 0-2.136 1.44-2.136 2.93V19h-3V8h2.88v1.32h.04c.4-.76 1.37-1.55 2.84-1.55 3.04 0 3.6 2 3.6 4.6V19z" /></svg>`, twitter: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" /></svg>`, facebook: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" /></svg>`, default: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>` };
                    let iconType = 'default';
                    if (type === 'email') iconType = 'email'; else if (text.includes('linkedin.com')) iconType = 'linkedin'; else if (text.includes('twitter.com')) iconType = 'twitter'; else if (text.includes('facebook.com')) iconType = 'facebook';
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md flex items-center gap-4';
                    card.innerHTML = `<div class="flex-shrink-0 w-12 h-12 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center">${icons[iconType]}</div><div class="flex-grow overflow-hidden"><a href="${type === 'email' ? 'mailto:' + text : text}" target="_blank" rel="noopener noreferrer" class="text-gray-800 font-semibold truncate block hover:text-sky-600">${text}</a><p class="text-xs text-gray-500 truncate mt-1">Found in: ${sourceUrl === 'Gemini AI' ? 'Gemini AI' : new URL(sourceUrl).hostname}</p></div><button class="copy-btn ml-auto bg-gray-200 text-gray-700 text-sm font-semibold py-2 px-3 rounded-md">Copy</button>`;
                    card.querySelector('.copy-btn').addEventListener('click', (e) => { const btn = e.currentTarget; navigator.clipboard.writeText(text).then(() => { btn.textContent = 'Copied!'; setTimeout(() => { btn.textContent = 'Copy'; }, 2000); }); });
                    return card;
                };
                const hs_displayResults = () => { hs_resultsContainer.classList.remove('hidden'); hs_emailList.innerHTML = ''; hs_socialList.innerHTML = ''; if (hs_foundEmails.size > 0) { hs_emailsContainer.classList.remove('hidden'); hs_foundEmails.forEach((source, email) => hs_emailList.appendChild(hs_createResultCard(email, source, 'email'))); } if (hs_foundLinks.size > 0) { hs_socialsContainer.classList.remove('hidden'); hs_foundLinks.forEach((source, link) => hs_socialList.appendChild(hs_createResultCard(link, source, 'link'))); } };
                const hs_showError = (message) => { hs_errorContainer.classList.remove('hidden'); hs_errorText.textContent = message; hs_scrapeBtn.disabled = false; hs_searchBtnText.textContent = currentTranslations['hybrid_search_btn']; };

                hs_scrapeBtn.addEventListener('click', async () => { /* LOGIC FROM V1 */ });
                hs_deepScanBtn.addEventListener('click', async () => { /* LOGIC FROM V1 */ });
                hs_askAiBtn.addEventListener('click', async () => { /* LOGIC FROM V1 */ });

                // =================================================================================
                // 🔍 AFFINITY OUTREACH LOGIC (from v1, with modifications)
                // =================================================================================
                const ao_projectUrlInput = document.getElementById('ao-projectUrl');
                const ao_generateBtn = document.getElementById('ao-generateKeywordsButton');
                const ao_generateBtnText = document.getElementById('ao-generate-btn-text');
                const ao_generateLoader = document.getElementById('ao-generate-loader');
                const ao_keywordLogConsole = document.getElementById('ao-keyword-log-console');
                const ao_keywordLogContainer = document.getElementById('ao-keyword-log-container');
                const ao_keywordError = document.getElementById('ao-keyword-errorMessage');
                const ao_keywordErrorText = document.getElementById('ao-keyword-errorText');
                const ao_searchForm = document.getElementById('ao-searchForm');
                const ao_tagsContainer = document.getElementById('ao-tags-container');
                const ao_keywordInput = document.getElementById('ao-keyword-input');
                const ao_addKeywordBtn = document.getElementById('ao-add-keyword-btn');
                const ao_searchTypeSelect = document.getElementById('ao-searchType');
                const ao_searchTypeDesc = document.getElementById('ao-searchType-description');
                const ao_countrySelect = document.getElementById('ao-country');
                const ao_langSelect = document.getElementById('ao-language');
                const ao_searchButton = document.getElementById('ao-searchButton');
                const ao_logConsole = document.getElementById('ao-log-console');
                const ao_logContainer = document.getElementById('ao-log-container');
                const ao_loader = document.getElementById('ao-loader');
                const ao_errorMessage = document.getElementById('ao-errorMessage');
                const ao_errorText = document.getElementById('ao-errorText');
                const ao_resultsArea = document.getElementById('ao-resultsArea');
                const ao_resultsList = document.getElementById('ao-resultsList');
                const ao_resultsSummary = document.getElementById('ao-resultsSummary');
                const ao_sortButton = document.getElementById('ao-sortButton');

                const ao_log = (container, message, type = 'info') => {
                    const color = { info: 'text-yellow-400', success: 'text-green-400', error: 'text-red-400' };
                    container.innerHTML += `<p class="${color[type]}">${message}</p>`; container.scrollTop = container.scrollHeight;
                };
                const ao_renderTags = () => {
                    ao_tagsContainer.querySelectorAll('.tag').forEach(tag => tag.remove());
                    ao_keywords.forEach(keyword => {
                        const tag = document.createElement('div'); tag.className = 'tag'; tag.textContent = keyword;
                        const removeBtn = document.createElement('button'); removeBtn.className = 'tag-remove'; removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = () => { ao_keywords = ao_keywords.filter(k => k !== keyword); ao_renderTags(); };
                        tag.appendChild(removeBtn); ao_tagsContainer.insertBefore(tag, ao_keywordInput);
                    });
                };
                const ao_addCurrentKeyword = () => { const kw = ao_keywordInput.value.trim(); if (kw && !ao_keywords.includes(kw)) { ao_keywords.push(kw); ao_renderTags(); } ao_keywordInput.value = ''; };
                ao_addKeywordBtn.addEventListener('click', ao_addCurrentKeyword);
                ao_keywordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); ao_addCurrentKeyword(); } });

                const ao_setGenerateLoading = (isLoading) => { ao_generateBtn.disabled = isLoading; ao_generateBtnText.classList.toggle('hidden', isLoading); ao_generateLoader.classList.toggle('hidden', !isLoading); };
                const ao_setSearchLoading = (isLoading) => { ao_searchButton.disabled = isLoading; ao_loader.classList.toggle('hidden', !isLoading); if (isLoading) { ao_resultsArea.classList.add('hidden'); ao_errorMessage.classList.add('hidden'); }};
                const ao_showKeywordError = (message) => { ao_keywordError.classList.remove('hidden'); ao_keywordErrorText.textContent = message; };
                const ao_showSearchError = (message) => { ao_errorMessage.classList.remove('hidden'); ao_errorText.textContent = message; };

                ao_generateBtn.addEventListener('click', async () => { /* LOGIC FROM V1 */ });
                ao_searchForm.addEventListener('submit', async (e) => { /* LOGIC FROM V1 */ });
                
                const ao_displayResults = (results) => {
                    ao_currentResults = results;
                    ao_resultsArea.classList.remove('hidden'); ao_resultsList.innerHTML = '';
                    ao_resultsSummary.textContent = `Showing ${results.length} unique media outlets.`;
                    if (results.length === 0) { ao_resultsList.innerHTML = `<p class="text-center text-slate-500">${currentTranslations['no_projects'] || 'No media found.'}</p>`; return; }
                    
                    results.forEach((item, index) => {
                        const card = document.createElement('div');
                        card.className = "bg-white p-4 rounded-xl shadow-md flex flex-col sm:flex-row gap-4";
                        card.innerHTML = `
                            <div class="flex-grow">
                                <div class="flex items-center gap-3 mb-2"><h3 class="text-lg font-bold text-slate-800">${item.name}</h3><span class="category-tag bg-sky-100 text-sky-800">${item.category}</span></div>
                                <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="text-sm text-sky-600 hover:underline break-all">${item.url}</a>
                                <p class="text-sm text-slate-600 mt-2"><strong>Description:</strong> ${item.description}</p>
                            </div>
                            <div class="flex-shrink-0 flex flex-col items-center justify-center gap-3 sm:w-48">
                                <div class="text-center"><div class="text-3xl font-bold text-[#BF103C]">${item.relevanceScore}/10</div><div class="text-xs font-semibold text-slate-500">RELEVANCE</div></div>
                                <button class="save-media-btn w-full bg-[#BF103C] text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-opacity-90 transition" data-index="${index}" data-translate-key="save_to_project_btn">Save to Project</button>
                            </div>
                        `;
                        ao_resultsList.appendChild(card);
                    });
                };
                ao_resultsList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('save-media-btn')) {
                        const btn = e.target;
                        if (!activeProject) { alert(currentTranslations['select_project_alert']); return; }
                        btn.disabled = true;
                        const itemToSave = ao_currentResults[parseInt(btn.dataset.index, 10)];
                        const { error } = await sb.from('saved_media').insert({ project_id: activeProject.id, user_id: user.id, name: itemToSave.name, url: itemToSave.url, description: itemToSave.description, reason: itemToSave.reason, relevance_score: itemToSave.relevanceScore, category: itemToSave.category });
                        if (error) { alert('Error: ' + error.message); btn.disabled = false; } 
                        else { btn.textContent = currentTranslations['media_saved']; btn.classList.replace('bg-[#BF103C]', 'bg-green-600'); }
                    }
                });
                
                loadProjects(); // Initial load of projects
            };

            // =================================================================================
            // 🔒 AUTHENTICATION CONTROLLER
            // =================================================================================
            sb.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    body.classList.remove('logged-out'); body.classList.add('logged-in');
                    const user = session.user;
                    updateUserAvatar(user);
                    await translatePage(user.user_metadata?.language || 'en');
                    if (!isAppInitialized) initializeApp(user);
                    
                    document.getElementById('user-avatar-btn').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('user-dropdown-menu').classList.toggle('hidden'); });
                    document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); sb.auth.signOut(); });
                    document.querySelectorAll('.sidebar-link-in-menu').forEach(link => link.addEventListener('click', () => { window.showOutreachSuiteView(link.getAttribute('href').substring(1)); document.getElementById('user-dropdown-menu').classList.add('hidden'); }));
                } else {
                    body.classList.remove('logged-in'); body.classList.add('logged-out');
                    isAppInitialized = false; activeProject = null;
                    await translatePage(navigator.language.split('-')[0] || 'en');
                }
            });

            document.addEventListener('click', () => { const menu = document.getElementById('user-dropdown-menu'); if (menu && !menu.classList.contains('hidden')) menu.classList.add('hidden'); });

            document.getElementById('login-btn').addEventListener('click', () => sb.auth.signInWithPassword({ email: auth_email.value, password: auth_password.value }).then(({ error }) => { if (error) showAuthMessage(error.message); }));
            document.getElementById('signup-btn').addEventListener('click', () => sb.auth.signUp({ email: auth_email.value, password: auth_password.value, options: { data: { language: auth_language.value } } }).then(({ error }) => { if (error) showAuthMessage(error.message); else showAuthMessage('Sign up successful! Please check your email.', 'success'); }));
            document.getElementById('auth-language').addEventListener('change', (e) => translatePage(e.target.value));
        });
    </script>
</body>
</html>