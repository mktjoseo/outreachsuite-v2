<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OutreachSuite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .console-font { font-family: 'Fira Code', monospace; }
        #log-container::-webkit-scrollbar, #ao-keyword-log-container::-webkit-scrollbar, #ao-log-container::-webkit-scrollbar { width: 8px; }
        #log-container::-webkit-scrollbar-track, #ao-keyword-log-container::-webkit-scrollbar-track, #ao-log-container::-webkit-scrollbar-track { background: #2d3748; }
        #log-container::-webkit-scrollbar-thumb, #ao-keyword-log-container::-webkit-scrollbar-thumb, #ao-log-container::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 20px; border: 3px solid #2d3748; }
        .disabled-btn, #scrapeBtn:disabled, #ao-searchButton:disabled, #ao-generateKeywordsButton:disabled { opacity: 0.6; cursor: not-allowed; }
        .sidebar-link { display: flex; align-items: center; gap: 0.75rem; color: #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem; transition: color 0.2s, background-color 0.2s; }
        .sidebar-link:hover { background-color: rgba(71, 85, 105, 0.5); }
        .sidebar-link.active { background-color: #475569; color: #ffffff; font-weight: 600; }
        .loader { border-top-color: #BF103C; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #BF103C;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin: 0.25rem 0.4rem 0.25rem 0;
        }
        .tag-remove {
            margin-left: 0.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.2);
            color: white;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .tag-remove:hover {
            background-color: rgba(0,0,0,0.4);
        }
        .category-tag {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="relative min-h-screen md:flex">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        <aside id="sidebar" class="w-64 bg-slate-800 text-white flex flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex items-center justify-between p-6 text-2xl font-bold border-b border-slate-700">
                <span>OutreachSuite</span>
                <button id="close-menu-button" class="md:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <nav class="flex-grow p-4">
                <ul class="space-y-2">
                    <li><a href="#home" id="nav-home" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>Home</a></li>
                    <li><a href="#affinity-outreach" id="nav-affinity-outreach" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 1.5a1.5 1.5 0 00-1.293.707l-7 12a1.5 1.5 0 001.293 2.293h14a1.5 1.5 0 001.293-2.293l-7-12A1.5 1.5 0 0010 1.5zM9 6a1 1 0 112 0 1 1 0 01-2 0zm1 9a1 1 0 110-2 1 1 0 010 2z" clip-rule="evenodd" /><circle cx="10" cy="3" r="1.5" /><circle cx="3" cy="15" r="1.5" /><circle cx="17" cy="15" r="1.5" /></svg>Affinity Outreach</a></li>
                    <li><a href="#hybrid-scraper" id="nav-hybrid-scraper" class="sidebar-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>Hybrid Scraper</a></li>
                </ul>
            </nav>
            <div class="p-4 mt-auto border-t border-slate-700"><p class="text-xs text-slate-400 text-center">Made with <span class="text-red-500">â™¥</span> by Eduardo Bortolotti L.</p></div>
        </aside>

        <div class="flex-1 flex flex-col">
            <header class="p-4 md:hidden bg-white shadow-md">
                <button id="mobile-menu-button" class="text-slate-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
            </header>

            <main class="flex-1 p-6 lg:p-10 overflow-y-auto">
            
                <div id="home-view" class="view">
                    <header class="mb-8"><h1 class="text-4xl font-bold text-slate-800">Select a function</h1><p class="text-lg text-slate-500 mt-1">Choose one of the available tools to start.</p></header>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <a href="#affinity-outreach" class="view-switcher bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 group"><div class="flex-shrink-0 w-12 h-12 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 1.5a1.5 1.5 0 00-1.293.707l-7 12a1.5 1.5 0 001.293 2.293h14a1.5 1.5 0 001.293-2.293l-7-12A1.5 1.5 0 0010 1.5zM9 6a1 1 0 112 0 1 1 0 01-2 0zm1 9a1 1 0 110-2 1 1 0 010 2z" clip-rule="evenodd" /><circle cx="10" cy="3" r="1.5" /><circle cx="3" cy="15" r="1.5" /><circle cx="17" cy="15" r="1.5" /></svg></div><h3 class="text-xl font-bold text-slate-800 mt-4">Affinity Outreach</h3><p class="text-slate-500 mt-1">Finds relevant blogs and media for your topic with semantic suggestions.</p></a>
                        <a href="#hybrid-scraper" class="view-switcher bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 group"><div class="flex-shrink-0 w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg></div><h3 class="text-xl font-bold text-slate-800 mt-4">Hybrid Scraper</h3><p class="text-slate-500 mt-1">Scans any website to find contact emails and social media links.</p></a>
                    </div>
                </div>

                <div id="hybrid-scraper-view" class="view hidden">
                    <div class="container mx-auto max-w-5xl">
                        <header class="relative text-left mb-8">
                            <h1 class="text-4xl sm:text-5xl font-bold text-[#39414E]">Hybrid Scraper</h1>
                            <p class="mt-2 text-lg text-gray-500">Uncover contact information from any website. This tool performs a multi-level scan to find emails and social links. If the initial search yields no results, you'll have the option to engage our AI for a deeper, more comprehensive analysis of the entire web.</p>
                        </header>
                        <div class="bg-white p-4 rounded-xl shadow-lg"><div class="flex flex-col sm:flex-row gap-3"><input type="url" id="urlInput" placeholder="Enter the website URL to investigate..." class="flex-grow p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#BF103C] transition duration-200 text-lg"><button id="scrapeBtn" class="bg-[#BF103C] text-white font-semibold py-4 px-8 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#BF103C] transition-all duration-200 flex items-center justify-center text-lg"><span id="search-btn-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>Search</span></button></div></div>
                        <div id="log-console" class="mt-8 bg-gray-800 rounded-xl shadow-lg hidden"><div class="bg-gray-700 rounded-t-lg px-4 py-2 flex items-center"><span class="h-3 w-3 bg-red-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-yellow-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-green-500 rounded-full"></span><span class="ml-4 text-gray-300 console-font text-sm">Process Console</span></div><div id="log-container" class="p-4 console-font text-sm h-96 overflow-y-auto"></div></div>
                        <div id="prompt-container" class="mt-6 hidden"><div class="bg-gray-800 p-6 rounded-lg shadow-md text-left"><p class="text-lg font-semibold text-[#0FCCC9] console-font" id="prompt-message"></p><div id="prompt-links" class="mt-4 mb-6 p-4 bg-black bg-opacity-20 rounded-md space-y-2 max-h-48 overflow-y-auto"></div><div class="flex justify-center gap-4"><button id="deep-scan-btn" class="w-full bg-[#0FCCC9] text-[#39414E] font-bold py-3 px-6 rounded-lg hover:bg-opacity-90 transition-colors flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>Execute Deep Scan</button></div></div></div>
                        <div id="ai-prompt-container" class="mt-6 hidden"><div class="bg-gray-800 p-6 rounded-lg shadow-md text-left"><p class="text-lg font-semibold text-purple-400 console-font" id="ai-prompt-title"></p><p class="mt-2 text-gray-300 console-font" id="ai-prompt-subtitle"></p><div class="flex justify-center gap-4 mt-6"><button id="ask-ai-btn" class="w-full bg-[#BF103C] text-white font-bold py-3 px-6 rounded-lg hover:bg-opacity-90 transition-colors flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>Engage Gemini AI</button></div></div></div>
                        <div id="results" class="mt-10 hidden">
                            <h2 class="text-2xl font-bold text-[#39414E] mb-4">Final Results</h2>
                            <div id="emails-container" class="mb-8 hidden">
                                <h3 class="text-xl font-semibold text-gray-700 mb-3">Emails Found</h3>
                                <div id="emailList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                            </div>
                            <div id="socials-container" class="hidden">
                                <h3 class="text-xl font-semibold text-gray-700 mb-3">Social & Contact Links</h3>
                                <div id="socialList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                            </div>
                        </div>
                        <div id="error-message" class="hidden mt-6 bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-r-lg" role="alert"><p class="font-bold">An error occurred!</p><p id="error-text"></p></div>
                    </div>
                </div>

                <div id="affinity-outreach-view" class="view hidden">
                    <div class="container mx-auto max-w-4xl">
                        <header class="text-center mb-8"><h1 class="text-3xl md:text-4xl font-bold text-[#39414E] mb-2">Affinity Outreach Finder</h1><p class="text-gray-600">Discover relevant media outlets based on real SEO data.</p></header>
                        <main>
                            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                                <h3 class="text-xl font-bold text-slate-800 mb-4">1. Analyze Your Project for Keywords</h3>
                                <div>
                                    <label for="ao-projectUrl" class="block text-sm font-medium text-[#39414E] mb-2">Project URL</label>
                                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                        <input type="url" id="ao-projectUrl" class="w-full bg-gray-100 border border-gray-300 text-[#39414E] rounded-lg p-3 focus:ring-2 focus:ring-[#BF103C] transition" placeholder="e.g., https://yourproject.com">
                                        <div class="flex-shrink-0 flex">
                                            <button type="button" id="ao-generateKeywordsButton" class="bg-[#0FCCC9] hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg transition text-sm flex items-center justify-center w-full">
                                                <span id="ao-generate-btn-text">Analyze & Generate</span>
                                                <div id="ao-generate-loader" class="loader ease-linear rounded-full border-2 border-t-2 border-white h-4 w-4 ml-2 hidden"></div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div id="ao-keyword-log-console" class="hidden mt-4 bg-gray-800 rounded-xl shadow-lg">
                                    <div class="bg-gray-700 rounded-t-lg px-4 py-2 flex items-center">
                                        <span class="h-3 w-3 bg-red-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-yellow-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-green-500 rounded-full"></span>
                                        <span class="ml-4 text-gray-300 console-font text-sm">Keyword Analysis Log</span>
                                    </div>
                                    <div id="ao-keyword-log-container" class="p-4 console-font text-sm text-left text-gray-300 h-40 overflow-y-auto"></div>
                                </div>
                                <div id="ao-keyword-errorMessage" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative text-center" role="alert">
                                    <strong class="font-bold">Analysis Error!</strong>
                                    <span class="block sm:inline" id="ao-keyword-errorText"></span>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-xl font-bold text-slate-800 mb-4">2. Find Affinity Media</h3>
                                <form id="ao-searchForm">
                                    <div class="space-y-6">
                                        <div>
                                            <label for="ao-keyword-input" class="block text-sm font-medium text-[#39414E] mb-2">Keywords or Topics</label>
                                            <div class="flex items-center space-x-2 w-full bg-gray-100 border border-gray-300 rounded-lg p-1">
                                                <div id="ao-tags-container" class="flex-grow flex flex-wrap items-center gap-2">
                                                    <input type="text" id="ao-keyword-input" class="flex-grow bg-transparent border-none focus:ring-0 text-sm p-1" placeholder="Add keyword & press Enter...">
                                                </div>
                                                <button type="button" id="ao-add-keyword-btn" class="flex-shrink-0 bg-[#BF103C] text-white rounded-md h-8 w-14 text-sm font-bold hover:bg-opacity-80">Add</button>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                                            <div>
                                                <label for="ao-searchType" class="block text-sm font-medium text-[#39414E] mb-2">Search Type</label>
                                                <select id="ao-searchType" class="w-full bg-gray-100 border border-gray-300 text-[#39414E] rounded-lg p-3 focus:ring-2 focus:ring-[#BF103C] transition">
                                                    <option value="top_authority" selected>Top Authority (Top 1-10)</option>
                                                    <option value="established">Established Media (Top 11-30)</option>
                                                    <option value="rising_stars">Rising Stars (Top 31-50)</option>
                                                </select>
                                            </div>
                                            <div id="ao-searchType-description" class="bg-slate-50 p-3 rounded-lg text-sm text-slate-600 mt-2 md:mt-0"></div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label for="ao-country" class="block text-sm font-medium text-[#39414E] mb-2">Country</label>
                                                <select id="ao-country" class="w-full bg-gray-100 border border-gray-300 text-[#39414E] rounded-lg p-3 focus:ring-2 focus:ring-[#BF103C] transition">
                                                    <option value="AR">Argentina</option><option value="AT">Austria</option><option value="BR">Brazil</option><option value="CL">Chile</option><option value="CO">Colombia</option><option value="FR">France</option><option value="DE">Germany</option><option value="IT">Italy</option><option value="MX">Mexico</option><option value="PL">Poland</option><option value="PT">Portugal</option><option value="ES">Spain</option><option value="CH">Switzerland</option><option value="GB">United Kingdom</option><option value="US" selected>USA</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="ao-language" class="block text-sm font-medium text-[#39414E] mb-2">Language</label>
                                                <select id="ao-language" class="w-full bg-gray-100 border border-gray-300 text-[#39414E] rounded-lg p-3 focus:ring-2 focus:ring-[#BF103C] transition">
                                                    <option value="en" selected>English</option><option value="fr">French</option><option value="de">German</option><option value="it">Italian</option><option value="pl">Polish</option><option value="pt">Portuguese</option><option value="es">Spanish</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="flex justify-center pt-2">
                                            <button type="submit" id="ao-searchButton" class="w-full md:w-1/2 bg-[#BF103C] hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mr-2" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                                                Search Media
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <div id="ao-log-console" class="hidden mt-6 bg-gray-800 rounded-xl shadow-lg">
                                <div class="bg-gray-700 rounded-t-lg px-4 py-2 flex items-center">
                                    <span class="h-3 w-3 bg-red-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-yellow-500 rounded-full mr-2"></span><span class="h-3 w-3 bg-green-500 rounded-full"></span>
                                    <span class="ml-4 text-gray-300 console-font text-sm">Search Process Log</span>
                                </div>
                                <div id="ao-log-container" class="p-4 console-font text-sm text-left text-gray-300 h-48 overflow-y-auto"></div>
                            </div>
                            
                            <div id="ao-loader" class="hidden text-center my-10"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto mb-4"></div><p class="text-lg text-gray-500">Analyzing the web... This may take a moment.</p></div>
                            <div id="ao-errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative text-center mt-6" role="alert"><strong class="font-bold">Error!</strong><span class="block sm:inline" id="ao-errorText"></span></div>
                            
                            <div id="ao-resultsArea" class="hidden mt-12">
                                <section id="ao-directResultsSection">
                                    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                                        <h2 class="text-2xl font-bold text-[#39414E] mb-2 md:mb-0">Found Media</h2>
                                        <div class="flex space-x-2">
                                            <button id="ao-sortButton" class="bg-[#0FCCC9] hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg text-sm">Sort by Relevance</button>
                                            <button id="ao-exportButton" class="bg-[#BF103C] hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg text-sm">Export Selected</button>
                                        </div>
                                    </div>
                                    <div id="ao-resultsSummary" class="mb-4 text-sm text-gray-600"></div>
                                    <div id="ao-resultsList" class="space-y-4"></div>
                                    <div id="ao-paginationControls" class="mt-8 flex justify-center items-center space-x-4"></div>
                                </section>
                            </div>
                        </main>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL NAVIGATION AND VIEW HANDLING ---
            const views = document.querySelectorAll('.view');
            const navLinks = document.querySelectorAll('.sidebar-link');
            const viewSwitchers = document.querySelectorAll('.view-switcher');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const closeMenuButton = document.getElementById('close-menu-button');

            const toggleMenu = () => {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            };

            const showView = (viewId) => {
                const targetView = document.getElementById(viewId + '-view');
                views.forEach(view => view.classList.add('hidden'));
                if (targetView) targetView.classList.remove('hidden');
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === '#' + viewId);
                });
                window.scrollTo(0, 0); 
            };
            
            const handleLinkClick = (e) => {
                e.preventDefault();
                const viewId = e.currentTarget.getAttribute('href').substring(1);
                window.location.hash = viewId;
                showView(viewId);
                if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                    toggleMenu();
                }
            };

            mobileMenuButton.addEventListener('click', toggleMenu);
            closeMenuButton.addEventListener('click', toggleMenu);
            overlay.addEventListener('click', toggleMenu);
            navLinks.forEach(link => link.addEventListener('click', handleLinkClick));
            viewSwitchers.forEach(switcher => switcher.addEventListener('click', handleLinkClick));
            
            const initialView = window.location.hash ? window.location.hash.substring(1) : 'home';
            showView(initialView);
            
            window.showOutreachSuiteView = showView;

            // --- HYBRID SCRAPER LOGIC ---
            const hs_urlInput = document.getElementById('urlInput');
            const hs_scrapeBtn = document.getElementById('scrapeBtn');
            const hs_searchBtnText = document.getElementById('search-btn-text');
            const hs_logConsole = document.getElementById('log-console');
            const hs_logContainer = document.getElementById('log-container');
            const hs_promptContainer = document.getElementById('prompt-container');
            const hs_promptMessage = document.getElementById('prompt-message');
            const hs_promptLinks = document.getElementById('prompt-links');
            const hs_deepScanBtn = document.getElementById('deep-scan-btn');
            const hs_aiPromptContainer = document.getElementById('ai-prompt-container');
            const hs_aiPromptTitle = document.getElementById('ai-prompt-title');
            const hs_askAiBtn = document.getElementById('ask-ai-btn');
            const hs_resultsContainer = document.getElementById('results');
            const hs_emailsContainer = document.getElementById('emails-container');
            const hs_emailList = document.getElementById('emailList');
            const hs_socialsContainer = document.getElementById('socials-container');
            const hs_socialList = document.getElementById('socialList');
            const hs_errorContainer = document.getElementById('error-message');
            const hs_errorText = document.getElementById('error-text');
            let hs_foundEmails = new Map(), hs_foundLinks = new Map(), hs_internalLinks = new Set(), hs_targetDomain = '';

            const hs_log = (message, type = 'info') => {
                const color = { info: 'text-gray-300', success: 'text-green-400', error: 'text-red-400', warn: 'text-yellow-400', step: 'text-cyan-400 font-bold' };
                hs_logContainer.innerHTML += `<p class="${color[type]}"><span class="text-gray-500 mr-2">[${new Date().toLocaleTimeString()}]</span>${message}</p>`;
                hs_logContainer.scrollTop = hs_logContainer.scrollHeight;
            };

            const hs_resetUI = () => {
                hs_logConsole.classList.add('hidden'); hs_logContainer.innerHTML = '';
                hs_promptContainer.classList.add('hidden'); hs_aiPromptContainer.classList.add('hidden');
                hs_resultsContainer.classList.add('hidden'); hs_errorContainer.classList.add('hidden');
                hs_emailsContainer.classList.add('hidden'); hs_socialsContainer.classList.add('hidden');
                hs_emailList.innerHTML = ''; hs_socialList.innerHTML = '';
                hs_foundEmails.clear(); hs_foundLinks.clear(); hs_internalLinks.clear();
                hs_targetDomain = ''; hs_scrapeBtn.disabled = false;
                hs_searchBtnText.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>Search';
            };
            
            const hs_normalizeUrl = (url) => { let n = url.trim(); if (!/^(https?:\/\/)/i.test(n)) { n = 'https://' + n; } return n; };

            const hs_extractData = (html, sourceUrl) => {
                const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
                (html.match(emailRegex) || []).forEach(e => { const c = e.toLowerCase(); if (!/\.(png|jpg|jpeg|gif|svg|webp)$/i.test(c) && !hs_foundEmails.has(c)) { hs_foundEmails.set(c, sourceUrl); } });
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                doc.querySelectorAll('a[href]').forEach(link => {
                    const href = link.getAttribute('href');
                    if (!href) return;
                    if (href.startsWith('mailto:')) { const e = href.substring(7).split('?')[0].toLowerCase(); if (e && !hs_foundEmails.has(e)) hs_foundEmails.set(e, sourceUrl); return; }
                    try {
                        const fullUrl = new URL(href, sourceUrl);
                        const socialKeywords = ['linkedin.com/company', 'twitter.com', 'facebook.com', 'instagram.com', 'wa.me', 'whatsapp.com', 't.me', 'http://googleusercontent.com/youtube.com/5'];
                        const contactKeywords = ['contact', 'about', 'team', 'nosotros', 'contacto', 'acerca', 'impressum'];
                        if (socialKeywords.some(kw => fullUrl.href.includes(kw))) { if (!hs_foundLinks.has(fullUrl.href)) hs_foundLinks.set(fullUrl.href, sourceUrl); }
                        else { const lh = fullUrl.hostname.replace('www.', ''); if ((lh === hs_targetDomain || lh.endsWith(`.${hs_targetDomain}`)) && contactKeywords.some(kw => fullUrl.href.toLowerCase().includes(kw))) { hs_internalLinks.add(fullUrl.href); } }
                    } catch (e) {}
                });
            };

            const hs_createResultCard = (text, sourceUrl, type) => {
                const icons = { email: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>`, linkedin: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5V8h3zM6.5 6.73c-.966 0-1.75-.79-1.75-1.76s.784-1.76 1.75-1.76 1.75.79 1.75 1.76-.783 1.76-1.75 1.76zM19 19h-3v-5.6c0-1.33-.027-3.03-1.85-3.03-1.85 0-2.136 1.44-2.136 2.93V19h-3V8h2.88v1.32h.04c.4-.76 1.37-1.55 2.84-1.55 3.04 0 3.6 2 3.6 4.6V19z" /></svg>`, twitter: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" /></svg>`, facebook: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" /></svg>`, default: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>` };
                let iconType = 'default';
                if (type === 'email') iconType = 'email';
                if (text.includes('linkedin.com')) iconType = 'linkedin';
                if (text.includes('twitter.com')) iconType = 'twitter';
                if (text.includes('facebook.com')) iconType = 'facebook';
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md flex items-center gap-4 transition-all hover:shadow-lg hover:-translate-y-1';
                card.innerHTML = `<div class="flex-shrink-0 w-12 h-12 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center">${icons[iconType]}</div><div class="flex-grow overflow-hidden"><a href="${type === 'email' ? 'mailto:' + text : text}" target="_blank" rel="noopener noreferrer" class="text-gray-800 font-semibold truncate block hover:text-sky-600" title="${text}">${text}</a><p class="text-xs text-gray-500 truncate mt-1">Found in: ${sourceUrl === 'Gemini AI' ? 'Gemini AI' : new URL(sourceUrl).hostname}</p></div><button class="copy-btn ml-auto bg-gray-200 text-gray-700 text-sm font-semibold py-2 px-3 rounded-md hover:bg-gray-300 transition-colors flex-shrink-0">Copy</button>`;
                card.querySelector('.copy-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); const btn = e.currentTarget; navigator.clipboard.writeText(text).then(() => { btn.textContent = 'Copied!'; setTimeout(() => { btn.textContent = 'Copy'; }, 2000); }).catch(err => { btn.textContent = 'Error'; console.error('Failed to copy!', err); }); });
                return card;
            };

            const hs_displayResults = () => {
                hs_resultsContainer.classList.remove('hidden');
                hs_emailList.innerHTML = '';
                if (hs_foundEmails.size > 0) { hs_emailsContainer.classList.remove('hidden'); hs_foundEmails.forEach((source, email) => hs_emailList.appendChild(hs_createResultCard(email, source, 'email'))); }
                hs_socialList.innerHTML = '';
                if (hs_foundLinks.size > 0) { hs_socialsContainer.classList.remove('hidden'); hs_foundLinks.forEach((source, link) => hs_socialList.appendChild(hs_createResultCard(link, source, 'link'))); }
            };
            
            const hs_showError = (message) => { hs_errorContainer.classList.remove('hidden'); hs_errorText.textContent = message; hs_scrapeBtn.disabled = false; hs_searchBtnText.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>Search'; };

            hs_scrapeBtn.addEventListener('click', async () => {
                let url = hs_urlInput.value;
                if (!url) { hs_showError('Please enter a valid URL.'); return; }
                hs_resetUI();
                url = hs_normalizeUrl(url); hs_urlInput.value = url;
                hs_logConsole.classList.remove('hidden'); hs_scrapeBtn.disabled = true;
                hs_searchBtnText.innerHTML = '<div class="loader ease-linear rounded-full border-2 border-t-2 border-white h-6 w-6"></div>';
                try {
                    hs_targetDomain = new URL(url).hostname.replace('www.', '');
                    hs_log(`Starting scan on ${hs_targetDomain}`, 'step');
                    const response = await fetch(`/.netlify/functions/scrape?url=${encodeURIComponent(url)}`);
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(errorBody || `Failed to fetch URL. Status: ${response.status}. Site may be protected.`);
                    }
                    const initialHtmlContent = await response.text();
                    hs_log('Initial page content retrieved successfully.', 'success');
                    hs_extractData(initialHtmlContent, url);
                    hs_displayResults();
                    if (hs_internalLinks.size > 0) {
                        hs_log(`Found ${hs_internalLinks.size} potential high-value pages.`, 'warn');
                        hs_promptMessage.textContent = 'Initial scan found internal pages. Perform Deep Scan to find more contacts?';
                        hs_promptLinks.innerHTML = [...hs_internalLinks].map(link => `<p class="text-xs text-gray-400">${link}</p>`).join('');
                        hs_promptContainer.classList.remove('hidden');
                    } else if (hs_foundEmails.size === 0 && hs_foundLinks.size === 0) {
                        hs_log('No contacts found & no contact pages to deep scan.', 'warn');
                        hs_aiPromptTitle.textContent = `No contacts found on ${hs_targetDomain}. Ask AI for a likely contact?`;
                        hs_aiPromptContainer.classList.remove('hidden');
                    } else {
                        hs_scrapeBtn.disabled = false;
                        hs_searchBtnText.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>Search';
                    }
                } catch (error) {
                    const errorMessage = error.message || 'Unknown error. Check URL and try again.';
                    hs_log(errorMessage, 'error');
                    hs_showError(errorMessage);
                }
            });
            
            hs_deepScanBtn.addEventListener('click', async () => {
                hs_promptContainer.classList.add('hidden');
                hs_log('Starting Deep Scan...', 'step');
                hs_deepScanBtn.disabled = true; hs_deepScanBtn.innerHTML = 'Analyzing...';
                
                try {
                    hs_log('Asking AI to select the most promising links for deep scan...', 'info');
                    const triageResponse = await fetch('/.netlify/functions/triage-links', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ urls: [...hs_internalLinks] })
                    });
                    
                    if (!triageResponse.ok) {
                        const errorData = await triageResponse.json();
                        throw new Error(errorData.error || 'AI Triage failed.');
                    }

                    const { selectedUrls } = await triageResponse.json();

                    if (!selectedUrls || selectedUrls.length === 0) {
                        hs_log('AI triage did not find any promising links to scan.', 'warn');
                        throw new Error('No links selected by AI for deep scan.');
                    }

                    hs_log(`AI has selected ${selectedUrls.length} URLs for scanning.`, 'success');

                    const scanPromises = selectedUrls.map(link =>
                        fetch(`/.netlify/functions/scrape?url=${encodeURIComponent(link)}`)
                        .then(res => {
                             if (res.ok) {
                                hs_log(`Successfully scanned: ${link}`, 'success');
                                return res.text();
                             }
                             hs_log(`Could not scan ${link}: Status ${res.status}`, 'error');
                             return '';
                        })
                        .then(html => { if (html) hs_extractData(html, link); })
                        .catch(err => hs_log(`Could not scan ${link}: ${err.message}`, 'error'))
                    );
                    
                    await Promise.all(scanPromises);
                    hs_log('Deep Scan completed. Updating results.', 'success');
                    hs_displayResults();

                } catch(error) {
                    hs_log(`Deep Scan Error: ${error.message}`, 'error');
                } finally {
                     if (hs_foundEmails.size === 0 && hs_foundLinks.size === 0) {
                        hs_log('Deep Scan finished, but still no contacts were found.', 'warn');
                        hs_aiPromptTitle.textContent = `Even after Deep Scan, no contacts found. Ask AI?`;
                        hs_aiPromptContainer.classList.remove('hidden');
                    } else {
                        hs_scrapeBtn.disabled = false;
                        hs_searchBtnText.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>Search';
                    }
                    hs_deepScanBtn.disabled = false; hs_deepScanBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>Execute Deep Scan';
                }
            });
            
            hs_askAiBtn.addEventListener('click', async () => {
                hs_aiPromptContainer.classList.add('hidden');
                hs_log(`Asking Gemini AI for a potential contact email for ${hs_targetDomain}...`, 'step');
                try {
                    const response = await fetch(`/.netlify/functions/ask-gemini?domain=${hs_targetDomain}`);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Gemini AI request failed.');
                    const aiEmail = data.email;
                    if (aiEmail && aiEmail.includes('@')) {
                        hs_log(`Gemini AI suggests: ${aiEmail}`, 'success');
                        if (!hs_foundEmails.has(aiEmail)) {
                            hs_foundEmails.set(aiEmail, 'Gemini AI');
                            hs_displayResults();
                        }
                    } else {
                        hs_log('Gemini AI could not find a likely contact email.', 'warn');
                    }
                } catch (error) {
                    hs_log(error.message, 'error'); hs_showError(error.message);
                } finally {
                    hs_scrapeBtn.disabled = false;
                    hs_searchBtnText.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>Search';
                }
            });

            // -------- AFFINITY OUTREACH LOGIC ---
            const ao_projectUrlInput = document.getElementById('ao-projectUrl');
            const ao_generateBtn = document.getElementById('ao-generateKeywordsButton');
            const ao_generateBtnText = document.getElementById('ao-generate-btn-text');
            const ao_generateLoader = document.getElementById('ao-generate-loader');
            const ao_keywordLogConsole = document.getElementById('ao-keyword-log-console');
            const ao_keywordLogContainer = document.getElementById('ao-keyword-log-container');
            const ao_keywordError = document.getElementById('ao-keyword-errorMessage');
            const ao_keywordErrorText = document.getElementById('ao-keyword-errorText');
            const ao_searchForm = document.getElementById('ao-searchForm');
            const ao_tagsContainer = document.getElementById('ao-tags-container');
            const ao_keywordInput = document.getElementById('ao-keyword-input');
            const ao_addKeywordBtn = document.getElementById('ao-add-keyword-btn');
            const ao_searchTypeSelect = document.getElementById('ao-searchType');
            const ao_searchTypeDesc = document.getElementById('ao-searchType-description');
            const ao_countrySelect = document.getElementById('ao-country');
            const ao_langSelect = document.getElementById('ao-language');
            const ao_searchButton = document.getElementById('ao-searchButton');
            const ao_logConsole = document.getElementById('ao-log-console');
            const ao_logContainer = document.getElementById('ao-log-container');
            const ao_loader = document.getElementById('ao-loader');
            const ao_errorMessage = document.getElementById('ao-errorMessage');
            const ao_errorText = document.getElementById('ao-errorText');
            const ao_resultsArea = document.getElementById('ao-resultsArea');
            const ao_resultsList = document.getElementById('ao-resultsList');
            const ao_resultsSummary = document.getElementById('ao-resultsSummary');
            const ao_exportButton = document.getElementById('ao-exportButton');
            const ao_sortButton = document.getElementById('ao-sortButton');
            
            let ao_keywords = [];
            let ao_currentResults = [];

            const ao_log = (container, message, type = 'info') => {
                const color = { info: 'text-yellow-400', success: 'text-green-400', error: 'text-red-400' };
                container.innerHTML += `<p class="${color[type]}"><span class="text-gray-500 mr-2">[${new Date().toLocaleTimeString()}]</span>${message}</p>`;
                container.scrollTop = container.scrollHeight;
            };

            const ao_renderTags = () => {
                ao_tagsContainer.querySelectorAll('.tag').forEach(tag => tag.remove());
                ao_keywords.forEach(keyword => {
                    const tag = document.createElement('div');
                    tag.className = 'tag'; tag.textContent = keyword;
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'tag-remove'; removeBtn.innerHTML = 'Ã—';
                    removeBtn.onclick = () => { ao_keywords = ao_keywords.filter(k => k !== keyword); ao_renderTags(); };
                    tag.appendChild(removeBtn);
                    ao_tagsContainer.insertBefore(tag, ao_keywordInput);
                });
            };
            
            const ao_addCurrentKeyword = () => {
                const newKeyword = ao_keywordInput.value.trim();
                if (newKeyword && !ao_keywords.includes(newKeyword)) {
                    ao_keywords.push(newKeyword);
                    ao_renderTags();
                }
                ao_keywordInput.value = ''; ao_keywordInput.focus();
            };
            
            ao_addKeywordBtn.addEventListener('click', ao_addCurrentKeyword);
            ao_keywordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); ao_addCurrentKeyword(); }
            });

            const ao_addKeywordsToTagInput = (newKeywords) => {
                newKeywords.forEach(kw => { if (!ao_keywords.includes(kw)) ao_keywords.push(kw); });
                ao_renderTags();
            };
            
            const ao_searchTypeDescriptions = {
                top_authority: "Finds biggest sites (Wikipedia, major news). Good for understanding main players, but hard for outreach.",
                established: "Finds well-known blogs and niche sites. The sweet spot for quality backlink opportunities.",
                rising_stars: "Finds newer or smaller blogs gaining traction. Often more open to collaboration and can be hidden gems."
            };
            const ao_updateSearchDesc = () => { ao_searchTypeDesc.textContent = ao_searchTypeDescriptions[ao_searchTypeSelect.value]; };
            ao_searchTypeSelect.addEventListener('change', ao_updateSearchDesc);
            ao_updateSearchDesc();

            const ao_setGenerateLoading = (isLoading) => {
                ao_generateBtn.disabled = isLoading;
                ao_generateBtnText.classList.toggle('hidden', isLoading);
                ao_generateLoader.classList.toggle('hidden', !isLoading);
            };
            
            const ao_setSearchLoading = (isLoading) => {
                ao_searchButton.disabled = isLoading;
                ao_loader.classList.toggle('hidden', !isLoading);
                if (isLoading) { ao_resultsArea.classList.add('hidden'); ao_errorMessage.classList.add('hidden'); ao_logConsole.classList.add('hidden'); ao_logContainer.innerHTML = ''; }
            };

            const ao_showKeywordError = (message) => { ao_keywordError.classList.remove('hidden'); ao_keywordErrorText.textContent = message; };
            const ao_showSearchError = (message) => { ao_errorMessage.classList.remove('hidden'); ao_errorText.textContent = message; };

            const ao_normalizeUrl = (url) => {
                let normalized = url.trim();
                if (!/^(https?:\/\/)/i.test(normalized)) { normalized = 'https://' + normalized; }
                return normalized;
            };
            
            ao_generateBtn.addEventListener('click', async () => {
                let projectUrl = ao_projectUrlInput.value;
                if (!projectUrl) { ao_showKeywordError("Please enter a project URL to analyze."); return; }
                projectUrl = ao_normalizeUrl(projectUrl); ao_projectUrlInput.value = projectUrl;
                ao_setGenerateLoading(true);
                ao_keywordLogConsole.classList.remove('hidden'); ao_keywordLogContainer.innerHTML = ''; ao_keywordError.classList.add('hidden');
                ao_log(ao_keywordLogContainer, '[INFO] Initiating analysis... Contacting server...', 'info');
                try {
                    const response = await fetch('/.netlify/functions/generate-keywords', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectUrl })
                    });
                    const data = await response.json();
                    if(data.log && Array.isArray(data.log)) {
                        ao_keywordLogContainer.innerHTML = '';
                        data.log.forEach(logEntry => {
                            let type = 'info';
                            if (logEntry.includes('[SUCCESS]')) type = 'success';
                            if (logEntry.includes('[ERROR]') || logEntry.includes('[FATAL]')) type = 'error';
                             if (logEntry.includes('[WARN]')) type = 'info';
                            ao_log(ao_keywordLogContainer, logEntry, type);
                        });
                    }
                    if (!response.ok) throw new Error(data.error || 'The server returned an error.');
                    const allKeywords = [...(data.existingKeywords || []), ...(data.opportunityKeywords || [])];
                    ao_addKeywordsToTagInput(allKeywords);
                } catch (error) {
                    ao_showKeywordError(error.message);
                } finally {
                    ao_setGenerateLoading(false);
                }
            });

            ao_searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (ao_keywords.length === 0) { ao_showSearchError("Please add at least one keyword."); return; }
                
                ao_setSearchLoading(true);
                
                const country = ao_countrySelect.value;
                const language = ao_langSelect.value;
                const searchType = ao_searchTypeSelect.value;
                const allLogs = [];

                const cacheKey = `outreach_search_${ao_keywords.join('_')}_${country}_${language}_${searchType}`;
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    const { timestamp, results, logs } = JSON.parse(cachedData);
                    if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
                        ao_logConsole.classList.remove('hidden');
                        ao_logContainer.innerHTML = '<p class="text-cyan-400">[INFO] Loading results from cache. To get fresh results, clear cache or change keywords.</p>';
                        (logs || []).forEach(log => ao_logContainer.insertAdjacentHTML('beforeend', log));
                        ao_displayResults(results);
                        ao_setSearchLoading(false);
                        return;
                    }
                }
                
                try {
                    const searchPromises = ao_keywords.map(keyword => {
                        const params = new URLSearchParams({ keyword, country, language, searchType });
                        return fetch(`/.netlify/functions/affinity-search?${params.toString()}`).then(res => res.json());
                    });

                    const resultsFromAllKeywords = await Promise.all(searchPromises);
                    let combinedResults = [];
                    
                    resultsFromAllKeywords.forEach(result => {
                        if (result.directResults) {
                            combinedResults.push(...result.directResults);
                        }
                        if (result.log) {
                            result.log.forEach(logEntry => {
                                let color = 'text-gray-300';
                                if (logEntry.includes('[SUCCESS]')) color = 'text-green-400';
                                else if (logEntry.includes('[INFO]')) color = 'text-cyan-400';
                                else if (logEntry.includes('[WARN]')) color = 'text-yellow-400';
                                else if (logEntry.includes('[FATAL ERROR]')) color = 'text-red-400';
                                allLogs.push(`<p class="${color}">${logEntry}</p>`);
                            });
                        }
                         if (result.error) {
                            allLogs.push(`<p class="text-red-400">[FATAL ERROR] ${result.error}</p>`);
                        }
                    });

                    const uniqueResults = Array.from(new Map(combinedResults.map(item => [item.url, item])).values());
                    
                    ao_logConsole.classList.remove('hidden');
                    ao_logContainer.innerHTML = allLogs.join('');
                    
                    const dataToCache = {
                        timestamp: Date.now(),
                        results: uniqueResults,
                        logs: allLogs
                    };
                    localStorage.setItem(cacheKey, JSON.stringify(dataToCache));

                    ao_displayResults(uniqueResults);

                } catch (error) {
                    ao_showSearchError(error.message);
                } finally {
                    ao_setSearchLoading(false);
                }
            });
            
            // --- CAMBIO ---: Actualizada la lÃ³gica de las etiquetas de categorÃ­a a inglÃ©s.
            const ao_displayResults = (results) => {
                ao_currentResults = results;
                ao_resultsArea.classList.remove('hidden'); ao_resultsList.innerHTML = '';
                if (results.length === 0) {
                    ao_resultsSummary.textContent = "No relevant media outlets found. Check log for details or try different keywords.";
                    return;
                }
                ao_resultsSummary.textContent = `Showing ${results.length} unique media outlets.`;
                results.forEach((result, index) => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-lg border border-gray-200 shadow-sm';
                    const relevanceColor = result.relevanceScore >= 8 ? 'bg-green-500' : result.relevanceScore >= 5 ? 'bg-yellow-400' : 'bg-red-400';

                    let categoryTag = '';
                    if (result.category) {
                        let catColor = 'bg-gray-200 text-gray-800'; // Default for "Other"
                        if (result.category === 'Specialist Media') catColor = 'bg-sky-100 text-sky-800';
                        if (result.category === 'Major Authority') catColor = 'bg-amber-100 text-amber-800';
                        categoryTag = `<span class="category-tag ${catColor}">${result.category}</span>`;
                    }
                    
                    card.innerHTML = `<div class="flex items-start space-x-4"><input type="checkbox" id="result-${index}" data-index="${index}" class="mt-1 h-4 w-4 text-[#BF103C] border-gray-300 rounded focus:ring-[#BF103C]"><div class="flex-1"><div class="flex flex-col sm:flex-row justify-between sm:items-start mb-3 gap-4"><h3 class="text-lg font-bold text-[#BF103C] mb-1 sm:mb-0"><a href="${result.url}" target="_blank" rel="noopener noreferrer" class="hover:underline">${result.name}</a></h3><div class="flex items-center space-x-4 flex-shrink-0">${categoryTag}<div class="flex items-center space-x-2"><span class="text-sm font-semibold text-gray-700">Relevance:</span><div class="w-24 bg-gray-200 rounded-full h-2.5"><div class="${relevanceColor} h-2.5 rounded-full" style="width: ${result.relevanceScore * 10}%"></div></div><span class="font-bold text-sm">${result.relevanceScore}/10</span></div></div></div><p class="text-sm text-gray-500 mb-3 break-all">${result.url}</p><p class="text-gray-700 mb-3 text-sm"><strong class="font-semibold">Summary:</strong> ${result.description}</p><p class="text-gray-700 text-sm"><strong class="font-semibold">Reasoning:</strong> ${result.reason}</p><div class="mt-4 pt-4 border-t border-gray-200 text-right"><button class="scrap-contact-btn bg-red-50 hover:bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg text-sm transition-colors" data-url="${result.url}">Scrap Contact</button></div></div></div>`;
                    ao_resultsList.appendChild(card);
                    card.querySelector('.scrap-contact-btn').addEventListener('click', (e) => {
                        const urlToScrap = e.currentTarget.dataset.url;
                        const hybridScraperInput = document.getElementById('urlInput');
                        if (hybridScraperInput) {
                            hybridScraperInput.value = urlToScrap;
                            if(window.showOutreachSuiteView) window.showOutreachSuiteView('hybrid-scraper');
                        }
                    });
                });
            };

            ao_sortButton.addEventListener('click', () => {
                if(ao_currentResults.length > 0) {
                    ao_currentResults.sort((a, b) => b.relevanceScore - a.relevanceScore);
                    ao_displayResults(ao_currentResults);
                }
            });

            ao_exportButton.addEventListener('click', () => {
                const selected = [];
                const checkboxes = ao_resultsList.querySelectorAll('input[type="checkbox"]:checked');
                checkboxes.forEach(cb => {
                    const index = cb.getAttribute('data-index');
                    if (ao_currentResults[index]) selected.push(ao_currentResults[index]);
                });
                if (selected.length === 0) { alert('Please select at least one item to export.'); return; }
                const textContent = selected.map(row => row.url).join('\n');
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url); link.setAttribute('download', 'exported_media_urls.txt');
                link.style.visibility = 'hidden'; document.body.appendChild(link);
                link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
            });
        });
    </script>
</body>
</html>